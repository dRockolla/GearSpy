"use strict";var checkRouting=function(a,b,c){return b.athlete?!0:void c.path("/")};checkRouting.$inject=["$q","$rootScope","$location"],angular.module("gearSpyApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","angularytics"]).config(["$routeProvider","AngularyticsProvider",function(a,b){a.when("/activities/:activityId",{templateUrl:"views/activity.html",controller:"ActivityCtrl",resolve:{factory:checkRouting}}).when("/activities",{templateUrl:"views/list.html",controller:"ActivityListCtrl",reloadOnSearch:!1,resolve:{factory:checkRouting}}).when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl"}).otherwise({redirectTo:"/home"})}]).run(["Angularytics",function(a){a.init()}]),angular.module("gearSpyApp").factory("d3Service",["$document","$window","$q","$rootScope",function(a,b,c,d){function e(){d.$apply(function(){f.resolve(window.d3)})}var f=c.defer(),g=a[0].createElement("script");g.type="text/javascript",g.async=!0,g.src="http://d3js.org/d3.v3.min.js",g.onreadystatechange=function(){"complete"==this.readyState&&e()},g.onload=e;var h=a[0].getElementsByTagName("body")[0];return h.appendChild(g),{d3:function(){return f.promise}}}]),angular.module("gearSpyApp").factory("Activity",["$http","$routeParams",function(a,b){return{id:null,get:function(c){var d=this.id?this.id:b.activityId;a.get("http://localhost:8079/inc/GearSpy.php?action=activity&id="+d).success(function(a){c(a)})}}}]),angular.module("gearSpyApp").factory("User",["$http",function(a){return{get:function(b){a.get("http://localhost:8079/inc/GearSpy.php?action=auth").success(function(a){b(a)})}}}]),angular.module("gearSpyApp").factory("ActivityList",["$http",function(a){return{activities:null,get:function(b){this.activities||a.get("http://localhost:8079/inc/GearSpy.php?action=initui").success(function(a){b(a.activities)})}}}]),angular.module("gearSpyApp").factory("GearSpy",["d3Service",function(a){return{h:350,w:700,padding:30,barOffset:null,dataset:null,gearing:null,plotSpdCadnc:function(b){d3=a,this.w=d3.select(".map").property("width"),this.h=Math.round(this.w/2),this.barOffset=this.padding+52;var c=null;d3.select(".spdCdnc").empty()?(c=d3.select("#scatter").classed("svg-container",!0).append("svg").attr("width",this.w).attr("height",this.h).attr("class","spdCdnc").attr("preserveAspectRatio","xMinYMin meet").classed("svg-content-responsive",!0).attr("viewBox","0 0 "+this.w+" "+this.h),c.append("clipPath").attr("id","chart-area").append("rect").attr("x",this.padding).attr("y",this.padding).attr("width",this.w-3*this.padding).attr("height",this.h-2*this.padding),c.append("g").attr("id","circles").attr("clip-path","url(#chart-area)")):c=d3.select(".spdCdnc");var d=d3.max(b,function(a){return a.gear.ratio}),e=d3.min(b,function(a){return a.gear.ratio}),f=d3.scale.linear().domain([0,d3.max(b,function(a){return a.speed})]).range([this.padding,this.w-this.padding]),g=d3.scale.linear().domain([0,d3.max(b,function(a){return a.cadence})]).range([this.h-this.padding,this.padding]),h=d3.scale.category20(),i=d3.scale.linear().domain([e,d]).range([0,20]),j=c.selectAll("circle").data(b),k=j;k.attr("class","data-point").attr("opacity",0).transition().delay(function(a,b){return 40*b}).duration(500).attr("cx",function(a){return Math.round(f(a.speed))}).attr("cy",function(a){return Math.round(g(a.cadence))}).attr("opacity",.8).attr("r",4).attr("fill",function(a){return h(i(a.gear.ratio))}).each("end",function(){d3.select(this).attr("opacity",.3).attr("r",3)});j.enter().append("circle").attr("class","data-point").transition().delay(function(a,b){return 40*b}).duration(500).attr("cx",function(a){return Math.round(f(a.speed))}).attr("cy",function(a){return Math.round(g(a.cadence))}).attr("opacity",.8).attr("r",4).attr("fill",function(a){return h(i(a.gear.chainring+a.gear.cog))}).each("end",function(){d3.select(this).attr("opacity",.3).attr("r",3)});j.exit().remove(),d3.selectAll(".axis").empty()&&(c.append("g").attr("class","axis").attr("transform","translate(0,"+(this.h-this.padding)+")").call(d3.svg.axis().scale(f).orient("bottom")),c.append("g").attr("class","axis").attr("transform","translate("+this.padding+",0)").call(d3.svg.axis().scale(g).orient("left").ticks(5)))},plotGearPie:function(a){var b=d3.max(a,function(a){return a.chainring}),c=Math.round(b/Math.PI);d3.select(".barChart").empty()&&(d3.select("#barChart").append("svg").attr("class","barChart").attr("width",this.w).attr("height",c*a.length*2.2+this.padding),this.reOrder({value:""})),this.updateBars(a)},updateBars:function(a){var b=d3.max(a,function(a){return a.chainring}),c=Math.round(b/Math.PI),d=d3.scale.linear().domain([d3.min(a,function(a){return a.percent}),d3.max(a,function(a){return a.percent})]).range([this.barOffset+c,this.w-this.padding]),e=(d3.scale.linear().domain([0,a.length]).range([this.padding,this.h-this.padding]),d3.scale.category20()),f=d3.scale.linear().domain([d3.min(a,function(a){return a.ratio}),d3.max(a,function(a){return a.ratio})]).range([0,20]),g=d3.select(".barChart"),h=g.selectAll(".barGroup").data(a),i=h;i.select("line").attr("x1",2*b).attr("y1",0).attr("x2",2*b).attr("y2",0).transition().duration(1e3).attr("y2",0).attr("x2",function(a){return d(a.percent)}),i.select(".chainring").attr("cx",25+b/2).attr("cy",0).attr("r",function(a){return Math.round(a.chainring/Math.PI)}).attr("fill",function(a,b){return e(f(a.chainring))}),i.select(".cog").attr("cx",parseInt(25)+parseInt(b)+parseInt(5)).attr("cy",0).attr("r",function(a){return Math.round(a.cog/Math.PI)}).attr("fill",function(a,b){return e(f(a.cog))}),i.select(".percent").text(function(a){return a.percent+"%"}).attr("class","percent").attr("x",2*b).attr("y",0).transition().duration(1e3).attr("x",function(a){return d(a.percent)-5}),i.select(".distance").text(function(a){return Math.round(a.distance/1609.344*100)/100+" mi"}).attr("class","distance").attr("x",2*b).attr("y",0).transition().duration(1e3).attr("x",function(a){return d(a.percent)+5}),i.select(".gear").text(function(a){return a.chainring+"-"+a.cog}).attr("class","gear").attr("x",0).attr("y",0);var j=h.enter().append("g").attr("class","barGroup").attr("transform",function(a,b){return"translate(0, "+2.2*c*(b+1)+")"});j.append("line").attr("x1",2*b).attr("y1",0).attr("x2",2*b).attr("y2",0).attr("stroke",function(a){return e(f(a.ratio))}).transition().duration(1e3).attr("y2",0).attr("x2",function(a){return d(a.percent)}),j.append("circle").attr("class","chainring").attr("cx",25+b/2).attr("cy",0).attr("r",function(a){return Math.round(a.chainring/Math.PI)}).attr("fill",function(a,b){return e(f(a.chainring))}),j.append("circle").attr("class","cog").attr("cx",25+b+5).attr("cy",0).attr("r",function(a){return Math.round(a.cog/Math.PI)}).attr("fill",function(a,b){return e(f(a.cog))}),j.append("text").text(function(a){return a.percent+"%"}).attr("class","percent").attr("x",2*b).attr("y",0).transition().duration(1e3).attr("x",function(a){return d(a.percent)-5}).each(function(a){a.visible=d(a.percent)>145}).style("display",function(a){return a.visible?null:"none"}),j.append("text").text(function(a){return Math.round(a.distance/1609.344*100)/100+" mi"}).attr("class","distance").attr("x",2*b).attr("y",0).transition().duration(1e3).attr("x",function(a){return d(a.percent)+5}),j.append("text").text(function(a){return a.chainring+"-"+a.cog}).attr("class","gear").attr("x",0).attr("y",0);h.exit().transition().duration(500).attr("transform",function(a,b){return"translate(800, 0)"}).remove();this.reOrder(this.sort)},plotClimbing:function(a){var b=d3.scale.linear().domain([d3.min(a,function(a){return a.distance}),d3.max(a,function(a){return a.distance})]).range([this.padding,this.w-this.padding]),c=d3.scale.linear().domain([d3.min(a,function(a){return a.altitude}),d3.max(a,function(a){return a.altitude})]).range([this.h-this.padding,this.padding]),d=d3.scale.category20(),e=d3.scale.linear().domain([d3.min(a,function(a){return a.gear.ratio}),d3.max(a,function(a){return a.gear.ratio})]).range([0,20]);if(d3.select(".elevationPlot").empty()){var f=d3.select("#elevationPlot").classed("svg-container",!0).attr("width",this.w).attr("height",this.h).append("svg").attr("class","elevationPlot").attr("preserveAspectRatio","xMinYMin meet").classed("svg-content-responsive",!0).attr("viewBox","0 0 "+this.w+" "+this.h);f.append("clipPath").attr("id","elev-area").append("rect").attr("x",this.padding).attr("y",this.padding).attr("width",this.w-2*this.padding).attr("height",this.h-2*this.padding),d3.selectAll(".eAxis").empty()&&(f.append("g").attr("class","eAxis").attr("transform","translate(0,"+(this.h-this.padding)+")").call(d3.svg.axis().scale(b).orient("bottom")),f.append("g").attr("class","eAxis").attr("transform","translate("+this.padding+",0)").call(d3.svg.axis().scale(c).orient("left").ticks(5)))}var g=d3.select(".elevationPlot").append("g").attr("class","elevGroup").attr("clip-path","url(#elev-area)"),h=d3.svg.line().x(function(a){return b(a.distance)}).y(function(a){return c(a.altitude)}).interpolate("basis");d3.svg.area().x(function(a){return b(a.distance)}).y0(this.h).y1(function(a){return c(a.altitude)}),g.selectAll(".elev-bars").data(a).enter().append("line").attr("x1",function(a){return b(a.distance)}).attr("y1",this.h).transition().attr("x2",function(a){return b(a.distance)}).attr("y2",function(a){return c(a.altitude)}).attr("class","elev-bars").attr("stroke-width",2).attr("stroke",function(a){return d(e(a.gear.ratio))}).attr("opacity",.8);g.append("path").datum(a).attr("d",h).attr("class","line")},reOrder:function(a){var b;switch(a.value){case"gears":b=this.dataset.gears.sort(function(a,b){return 2*parseInt(a.chainring)+parseInt(a.cog)>2*parseInt(b.chainring)+parseInt(b.cog)?-1:1});break;case"percent":b=this.dataset.gears.sort(function(a,b){return a.percent<b.percent?1:-1});break;case"ratio":b=this.dataset.gears.sort(function(a,b){return a.ratio<b.ratio?-1:1});break;default:b=this.dataset.gears}this.dataset.gears=b;var c=d3.max(b,function(a){return a.chainring}),d=Math.round(c/Math.PI);d3.selectAll(".barGroup").data(b,function(a){return a.ratio}).transition().duration(1e3).attr("transform",function(a,b){return"translate(0, "+2.2*d*(b+1)+")"})}}}]),angular.module("gearSpyApp").controller("ActivityListCtrl",["$scope","ActivityList","$location",function(a,b,c){a.activities||(b.get(function(b){a.activities=b,a.auth=!0}),b.activities=a.activities),a.getActivity=function(b){a.$parent.getActivity(b)}}]),angular.module("gearSpyApp").controller("ActivityCtrl",["$scope","$location","Activity","Angularytics",function(a,b,c,d){c.get(function(b){a.activityLoaded=!0,a.activity=b.activity}),a.getActivity=function(b){d.trackEvent("Activity List","showRide"),a.id=b,c.id=b,c.get(function(b){a.activityLoaded=!0,a.activity=b.activity})}}]),angular.module("gearSpyApp").controller("UserCtrl",["$scope","User","$http","$rootScope","$location",function(a,b,c,d,e){void 0===d.athlete&&b.get(function(a){d.athlete=a.athlete}),a.logout=function(){c.get("http://localhost:8079/inc/GearSpy.php?action=logout").success(function(b){a.retUrl=b.retUrl,d.auth=!1,e.path("/")})}}]),angular.module("gearSpyApp").controller("GearCtrl",["$scope","$http","GearSpy","Angularytics",function(a,b,c,d){a.wheel=700,a.spd=10,a.options=[{text:"ratio",value:"ratio"},{text:"Percent Used",value:"percent"},{text:"gears",value:"gears"}],a.mySort=a.options[0],a.showGearForm=!1,a.selectSort=function(){c.reOrder(a.mySort)},a.spy=function(e){d.trackEvent("Activity Page","spy");var f={action:"spy",id:e,wheel:a.wheel,speed:a.spd,chainrings:a.chainrings,cassette:a.cassette};b.post("http://localhost:8079/inc/GearSpy.php?action=spy",f).success(function(b){a.showGearForm=!0,c.sort=a.mySort,c.dataset=b,a.chainrings=b.chainrings.toString(),a.cassette=b.cassette.toString(),c.plotSpdCadnc(b.points),c.plotGearPie(b.gears),c.plotClimbing(b.points)})},a.spyharder=function(d){var e={action:"spyharder",id:d,wheel:a.wheel,speed:a.spd,chainrings:a.chainrings,cassette:a.cassette};b.post("http://localhost:8079/inc/GearSpy.php?action=spyharder",e).success(function(b){a.showGearForm=!0,c.sort=a.mySort,c.dataset=b,a.chainrings=b.chainrings.toString(),a.cassette=b.cassette.toString(),c.plotSpdCadnc(b.points),c.plotGearPie(b.gears)})}}]),angular.module("gearSpyApp").controller("HomeCtrl",["$scope","$http","$location","$rootScope",function(a,b,c,d){var e=window.location.search?window.location.search+"&":"?",f="http://localhost:8079/inc/GearSpy.php"+e+"action=auth";b.get(f).success(function(b){200==b.status?(window.location.search.match("code=")&&(window.location="/"),d.auth=!0,d.athlete=b.athlete):(a.retUrl=b.retUrl,d.auth=!1,delete d.athlete)}).error(function(){console.log("Unable to contact server")}),a.logout=function(){b.get("http://localhost:8079/inc/GearSpy.php?action=logout").success(function(b){a.retUrl=b.retUrl,d.auth=!1,delete d.athlete})}}]),angular.module("gearSpyApp").run(["$templateCache",function(a){a.put("views/activity.html",'<div class="col-md-8 col-md-offset-2 ride-info" ng-controller="GearCtrl"> <ol class="breadcrumb"> <li><a href="#">Home</a></li> <li><a href="#/activities/">Activities</a></li> <li class="active" ng-bind="activity.name"></li> </ol> <div class="gs-section"> <h2 ng-bind="activity.name"></h2> <img class="map" src="//maps.googleapis.com/maps/api/staticmap?size=640x200&amp;path=weight:3%7Ccolor:red%7Cenc:{{activity.map.summary_polyline}}" alt="{{activity.name}}"> </div> <div class="gs-section"> <h3>Gears</h3> <div class="form-group"> <div class="btn-group" ng-show="false"> <label class="btn btn-primary" ng-model="wheel" btn-radio="700">700c</label> <label class="btn btn-primary" ng-model="wheel" btn-radio="650">650c</label> </div> <div class="btn-group"> <label class="btn btn-info" ng-model="spd" btn-radio="10">10 Speed</label> <label class="btn btn-info" ng-model="spd" btn-radio="11">11 Speed</label> </div> <div class="btn-spy"> <button class="btn btn-success" ng-click="spy(activity.id)" analytics-on="click">Spy</button> <button class="btn btn-danger" ng-click="spyharder(activity.id)" ng-show="false">Spy Again, but try harder this time</button> </div> <form name="setgears" class="form-inline" ng-show="chainrings"> <div class="alert alert-success">GearSpy\'s guess</div> <label for="chainrings">Chainrings</label> <input class="form-control" type="text" name="chainrings" ng-model="chainrings" required ng-disabled="!manual"> <label for="cogs">Cogs</label> <input class="form-control" type="text" name="cogs" ng-model="cassette" required ng-disabled="!manual"> <input class="form-control" type="checkbox" ng-model="manual" analytics-on="click" analytics-event="manual"> <label for="manual">Set Manually</label> <!-- span class="help-block error" >You can enter the cogs on your cassette, but let me try to guess first.</span --> <!-- span class="help-block error" ng-show="setgears.cogs.$dirty && setgears.cogs.$error.pattern">Please enter a space separated list of the number of teeth each cog.</span --> </form> </div> </div> <div id="sectionScatter" class="gs-section" ng-show="chainrings"> <h3>Cadence vs Speed</h3> <div id="scatter" class="canvas"></div> <div id="tooltip" class="hidden"><p id="value"></p></div> </div> <div id="sectionElevation" class="gs-section" ng-show="chainrings"> <h3>Gears in Profile</h3> <div id="elevationPlot" class="canvas"></div> </div> <div class="gs-section" ng-show="chainrings"> <h3>Gear Use</h3> <div class="use-chart"> <p> sort by: <select id="sort" ng-cloak ng-model="mySort" ng-options="o.text for o in options" ng-change="selectSort()"></select></p> <div id="barChart" class="canvas"></div> </div> </div> </div>'),a.put("views/home.html",'<div class="col-sm-10 col-sm-offset-1"> <div id="splash-frame"> <div class="frame image"> <img src="images/splash.583d2f0f.jpg"> </div> <div class="frame text"> <span ng-hide="auth"> <p>For GearSpy to work you will need both speed and cadence data. If you don\'t have a cadnece sensor, you\'re out of luck.</p> <a ng-href="{{retUrl}}" ng-cloak><img src="images/LogInWithStrava.a798e12a.png"></a> <p>You\'ll be sent over to Strava to okay GearSpy, then they\'ll send you right back.</p> </span> <span ng-show="auth"> <p>Welcome back <span ng-bind="athlete.firstname"></span> <span ng-bind="athlete.lastname"></span>, let\'s get started.</p> <a href="#/activities"><button class="btn btn-success">Show me my rides</button></a> <button class="btn" ng-click="logout()">Logout of Strava</button> </span> </div> </div> </div>'),a.put("views/list.html",'<div class="col-md-8 col-md-offset-2"> <ol class="breadcrumb"> <li><a href="#">Home</a></li> </ol> <div class="ride-list"> <div class="ride" ng-show="auth" ng-cloak ng-repeat="activity in activities" ng-cloak> <div class="caption"> <h3><span ng-bind="activity.name"></span></h3> <ul> <li><span ng-bind="activity.distance"></span></li> <li><span ng-bind="activity.total_elevation_gain"></span></li> <li><span ng-bind="activity.average_cadence"></span> rpm</li> </ul> </div> <a href="#/activities/{{activity.id}}" class="btn btn-success" ng-show="activity.average_cadence">Spy on this ride</a> <div class="alert alert-danger" ng-hide="activity.average_cadence">No cadence data</div> <div class="inner"> <img class="summary-map" src="//maps.googleapis.com/maps/api/staticmap?size=300x200&amp;path=weight:3%7Ccolor:red%7Cenc:{{activity.map.summary_polyline}}" alt="{{activity.name}}"> </div> </div> </div> </div>')}]);